// ========================================
// PRISMA SCHEMA - E-COMMERCE COMPLETE
// Production-ready con todas las mejoras
// ========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========================================
// HEADQUARTERS & MEMBERS (Sin cambios)
// ========================================

model Headquarters {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String   @db.VarChar(255)
  code              String   @unique @db.VarChar(20)
  city              String   @db.VarChar(100)
  phone             String?  @db.VarChar(20)
  email             String?  @db.VarChar(255)
  membership_prices Json
  status            String   @default("active") @db.VarChar(20)
  created_at        DateTime @default(now())
  updated_at        DateTime @default(now()) @updatedAt
  members           Member[]

  @@index([code])
  @@index([status])
  @@map("headquarters")
}

model Member {
  id                     String              @id @default(uuid()) @db.Uuid
  headquarters_id        String?             @db.Uuid
  member_number          String?             @unique @db.VarChar(50)
  email                  String              @unique @db.VarChar(255)
  first_name             String              @db.VarChar(100)
  last_name              String              @db.VarChar(100)
  first_surname          String?             @db.VarChar(100)
  second_surname         String?             @db.VarChar(100)
  nickname               String?             @db.VarChar(50)
  birth_date             DateTime            @db.Date
  dni                    String?             @db.VarChar(20)
  sex                    Sex
  phone                  String              @db.VarChar(20)
  emergency_phone        String?             @db.VarChar(20)
  emergency_contact_name String?             @db.VarChar(255)
  province               String              @db.VarChar(100)
  city                   String?             @db.VarChar(100)
  address                String
  postal_code            String?             @db.VarChar(10)
  shirt_size             String?             @db.VarChar(10)
  hoodie_size            String?             @db.VarChar(10)
  pants_size             String?             @db.VarChar(10)
  license_type           LicenseType
  fedme_license_number   String?             @unique @db.VarChar(50)
  fedme_status           FedmeStatus         @default(pending)
  membership_status      MembershipStatus    @default(pending)
  membership_start_date  DateTime?           @db.Date
  membership_end_date    DateTime?           @db.Date
  privacy_accepted       Boolean             @default(true)
  privacy_accepted_at    DateTime?
  privacy_accepted_ip    String?             @db.VarChar(45)
  privacy_policy_version String?             @default("1.0") @db.VarChar(20)
  marketing_consent      Boolean             @default(true)
  marketing_consent_at   DateTime?
  marketing_revoked_at   DateTime?
  whatsapp_consent       Boolean             @default(true)
  whatsapp_consent_at    DateTime?
  whatsapp_revoked_at    DateTime?
  deleted_at             DateTime?
  admin_notes            String?
  created_at             DateTime            @default(now())
  updated_at             DateTime            @updatedAt
  
  // Relations
  headquarters           Headquarters?       @relation(fields: [headquarters_id], references: [id])
  eventRegistrations     EventRegistration[]
  orders                 Order[]
  payments               Payment[]
  waiverAcceptances      WaiverAcceptance[]
  carts                  Cart[]
  shippingAddresses      ShippingAddress[]
  productReviews         ProductReview[]

  @@index([headquarters_id])
  @@index([email])
  @@index([dni])
  @@index([membership_status])
  @@index([member_number])
  @@index([created_at(sort: Desc)])
  @@index([privacy_accepted])
  @@index([marketing_consent])
  @@index([deleted_at])
  @@index([privacy_policy_version])
  @@map("members")
}

// ========================================
// EVENTS (Sin cambios)
// ========================================

model Event {
  id                   String              @id @default(uuid()) @db.Uuid
  slug                 String              @unique @db.VarChar(100)
  name                 String              @db.VarChar(255)
  description          String?
  event_date           DateTime
  location             String?             @db.VarChar(255)
  max_participants     Int?
  current_participants Int                 @default(0)
  price                Int
  currency             String              @default("eur") @db.VarChar(3)
  requires_member      Boolean             @default(false)
  member_discount      Int                 @default(0)
  custom_fields        Json?
  whatsapp_group       String?             @db.VarChar(500)
  status               EventStatus         @default(draft)
  image_url            String?             @db.VarChar(500)
  meta_description     String?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt
  registrations        EventRegistration[]
  waiverAcceptances    WaiverAcceptance[]

  @@index([slug])
  @@index([status])
  @@index([event_date])
  @@map("events")
}

model EventRegistration {
  id                     String               @id @default(uuid()) @db.Uuid
  event_id               String               @db.Uuid
  member_id              String?              @db.Uuid
  participant_name       String               @db.VarChar(255)
  participant_email      String               @db.VarChar(255)
  participant_phone      String               @db.VarChar(20)
  participant_dni        String               @db.VarChar(50)
  shirt_size             String?              @db.VarChar(10)
  ip_address             String?              @db.VarChar(45)
  custom_data            Json?
  status                 RegistrationStatus   @default(pending)
  privacy_accepted       Boolean              @default(false)
  privacy_accepted_at    DateTime?
  privacy_policy_version String?              @default("1.0") @db.VarChar(20)
  whatsapp_consent       Boolean              @default(false)
  whatsapp_consent_at    DateTime?
  marketing_consent      Boolean              @default(false)
  marketing_consent_at   DateTime?
  marketing_revoked_at   DateTime?
  registered_at          DateTime             @default(now())
  created_at             DateTime             @default(now())
  updated_at             DateTime             @updatedAt
  
  event                  Event                @relation(fields: [event_id], references: [id], onDelete: Cascade)
  member                 Member?              @relation(fields: [member_id], references: [id])
  payment                Payment?
  waiverAcceptances      WaiverAcceptance[]

  @@unique([event_id, participant_dni])
  @@index([event_id])
  @@index([member_id])
  @@index([participant_email])
  @@index([status])
  @@index([privacy_accepted])
  @@index([privacy_policy_version])
  @@index([marketing_consent])
  @@index([participant_dni])
  @@map("event_registrations")
}

// ========================================
// E-COMMERCE: CATEGORIES
// ========================================

model Category {
  id          String     @id @default(uuid()) @db.Uuid
  slug        String     @unique @db.VarChar(100)
  name        String     @db.VarChar(255)
  description String?
  
  parent_id   String?    @db.Uuid
  parent      Category?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  image_url   String?    @db.VarChar(500)
  sort_order  Int        @default(0)
  status      String     @default("active") @db.VarChar(20)
  
  created_at  DateTime   @default(now())
  updated_at  DateTime   @updatedAt
  
  products    ProductCategory[]
  
  @@index([slug])
  @@index([parent_id])
  @@index([status])
  @@index([sort_order])
  @@map("categories")
}

// ========================================
// E-COMMERCE: PRODUCTS
// ========================================

model Product {
  id                  String      @id @default(uuid()) @db.Uuid
  slug                String      @unique @db.VarChar(100)
  name                String      @db.VarChar(255)
  description         String?
  price               Int
  compare_at_price    Int?
  currency            String      @default("eur") @db.VarChar(3)
  stock               Int         @default(0)
  low_stock_threshold Int         @default(5)
  track_inventory     Boolean     @default(true)
  has_variants        Boolean     @default(false)
  variants            Json?
  tags                String[]
  images              Json?
  meta_title          String?     @db.VarChar(255)
  meta_description    String?
  status              String      @default("draft") @db.VarChar(20)
  featured            Boolean     @default(false)
  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt
  
  // Relations
  categories          ProductCategory[]
  orderItems          OrderItem[]
  cartItems           CartItem[]
  reviews             ProductReview[]
  stockReservations   StockReservation[]

  @@index([slug])
  @@index([status])
  @@index([featured])
  @@map("products")
}

model ProductCategory {
  product_id    String   @db.Uuid
  category_id   String   @db.Uuid
  
  product       Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  category      Category @relation(fields: [category_id], references: [id], onDelete: Cascade)
  
  @@id([product_id, category_id])
  @@index([product_id])
  @@index([category_id])
  @@map("product_categories")
}

// ========================================
// E-COMMERCE: CART (NUEVO)
// ========================================

model Cart {
  id                String     @id @default(uuid()) @db.Uuid
  session_id        String?    @unique @db.VarChar(255)
  member_id         String?    @db.Uuid
  guest_email       String?    @db.VarChar(255)
  
  marketing_consent    Boolean?
  marketing_consent_at DateTime?
  
  expires_at        DateTime
  created_at        DateTime   @default(now())
  updated_at        DateTime   @updatedAt
  
  items             CartItem[]
  member            Member?    @relation(fields: [member_id], references: [id])
  
  @@index([session_id])
  @@index([member_id])
  @@index([guest_email])
  @@index([expires_at])
  @@map("carts")
}

model CartItem {
  id           String   @id @default(uuid()) @db.Uuid
  cart_id      String   @db.Uuid
  product_id   String   @db.Uuid
  variant_data Json?
  quantity     Int
  unit_price   Int
  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  
  cart         Cart     @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [product_id], references: [id])
  
  @@index([cart_id])
  @@index([product_id])
  @@map("cart_items")
}

// ========================================
// E-COMMERCE: DISCOUNT CODES (NUEVO)
// ========================================

model DiscountCode {
  id                String       @id @default(uuid()) @db.Uuid
  code              String       @unique @db.VarChar(50)
  description       String?
  
  discount_type     DiscountType
  discount_value    Int
  
  min_purchase      Int?
  max_discount      Int?
  
  valid_from        DateTime?
  valid_until       DateTime?
  
  max_uses          Int?
  max_uses_per_user Int?         @default(1)
  current_uses      Int          @default(0)
  
  applicable_to     Json?
  members_only      Boolean      @default(false)
  
  status            String       @default("active") @db.VarChar(20)
  created_at        DateTime     @default(now())
  updated_at        DateTime     @updatedAt
  
  orders            Order[]
  
  @@index([code])
  @@index([status])
  @@index([valid_until])
  @@map("discount_codes")
}

// ========================================
// E-COMMERCE: ORDERS (MEJORADO)
// ========================================

model Order {
  id                     String         @id @default(uuid()) @db.Uuid
  order_number           String         @unique @db.VarChar(50)
  member_id              String?        @db.Uuid
  customer_email         String         @db.VarChar(255)
  customer_name          String         @db.VarChar(255)
  customer_phone         String?        @db.VarChar(20)
  
  // Dirección (mantener Json como snapshot)
  shipping_address_id    String?        @db.Uuid
  shipping_address       Json
  
  // Precios
  subtotal               Int
  shipping_cost          Int            @default(0)
  tax                    Int            @default(0)
  discount               Int            @default(0)
  total                  Int
  currency               String         @default("eur") @db.VarChar(3)
  
  // Cupón
  discount_code_id       String?        @db.Uuid
  discount_code          DiscountCode?  @relation(fields: [discount_code_id], references: [id])
  
  // Estado
  status                 OrderStatus    @default(pending)
  tracking_number        String?        @db.VarChar(255)
  shipped_at             DateTime?
  delivered_at           DateTime?
  
  // Notas
  customer_notes         String?
  admin_notes            String?
  
  // RGPD
  privacy_policy_version String?        @default("1.0") @db.VarChar(20)
  marketing_consent      Boolean        @default(false)
  marketing_consent_at   DateTime?
  marketing_revoked_at   DateTime?
  ip_address             String?        @db.VarChar(45)
  
  created_at             DateTime       @default(now())
  updated_at             DateTime       @updatedAt
  
  // Relations
  items                  OrderItem[]
  member                 Member?        @relation(fields: [member_id], references: [id])
  payments               Payment[]
  reviews                ProductReview[]

  @@index([order_number])
  @@index([member_id])
  @@index([customer_email])
  @@index([status])
  @@index([created_at(sort: Desc)])
  @@index([privacy_policy_version])
  @@index([marketing_consent])
  @@index([discount_code_id])
  @@map("orders")
}

model OrderItem {
  id           String   @id @default(uuid()) @db.Uuid
  order_id     String   @db.Uuid
  product_id   String?  @db.Uuid
  product_name String   @db.VarChar(255)
  product_slug String?  @db.VarChar(100)
  variant_data Json?
  quantity     Int
  unit_price   Int
  total_price  Int
  created_at   DateTime @default(now())
  
  order        Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product      Product? @relation(fields: [product_id], references: [id])

  @@index([order_id])
  @@index([product_id])
  @@map("order_items")
}

// ========================================
// E-COMMERCE: STOCK RESERVATIONS (NUEVO)
// ========================================

model StockReservation {
  id         String    @id @default(uuid()) @db.Uuid
  product_id String    @db.Uuid
  variant_id String?   @db.VarChar(100)
  quantity   Int
  
  cart_id    String?   @db.Uuid
  order_id   String?   @db.Uuid
  
  status     String    @default("active") @db.VarChar(20)
  expires_at DateTime
  
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt
  
  product    Product   @relation(fields: [product_id], references: [id])
  
  @@index([product_id])
  @@index([cart_id])
  @@index([order_id])
  @@index([expires_at])
  @@index([status])
  @@map("stock_reservations")
}

// ========================================
// E-COMMERCE: SHIPPING ADDRESSES (NUEVO)
// ========================================

model ShippingAddress {
  id             String   @id @default(uuid()) @db.Uuid
  member_id      String?  @db.Uuid
  guest_email    String?  @db.VarChar(255)
  
  label          String?  @db.VarChar(100)
  recipient_name String   @db.VarChar(255)
  address_line1  String   @db.VarChar(255)
  address_line2  String?  @db.VarChar(255)
  city           String   @db.VarChar(100)
  province       String   @db.VarChar(100)
  postal_code    String   @db.VarChar(10)
  country        String   @default("ES") @db.VarChar(2)
  phone          String   @db.VarChar(20)
  
  is_default     Boolean  @default(false)
  
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  
  member         Member?  @relation(fields: [member_id], references: [id])
  
  @@index([member_id])
  @@index([guest_email])
  @@map("shipping_addresses")
}

// ========================================
// E-COMMERCE: REVIEWS (NUEVO)
// ========================================

model ProductReview {
  id                 String   @id @default(uuid()) @db.Uuid
  product_id         String   @db.Uuid
  order_id           String?  @db.Uuid
  member_id          String?  @db.Uuid
  
  rating             Int
  title              String?  @db.VarChar(255)
  comment            String?  @db.Text
  
  verified_purchase  Boolean  @default(false)
  status             String   @default("pending") @db.VarChar(20)
  
  helpful_count      Int      @default(0)
  not_helpful_count  Int      @default(0)
  
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  
  product            Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  member             Member?  @relation(fields: [member_id], references: [id])
  order              Order?   @relation(fields: [order_id], references: [id])
  
  @@unique([order_id, product_id])
  @@index([product_id])
  @@index([member_id])
  @@index([status])
  @@index([rating])
  @@map("product_reviews")
}

// ========================================
// PAYMENTS (Sin cambios)
// ========================================

model Payment {
  id                    String             @id @default(uuid()) @db.Uuid
  payment_type          PaymentType
  member_id             String?            @db.Uuid
  event_registration_id String?            @unique @db.Uuid
  order_id              String?            @db.Uuid
  stripe_session_id     String             @unique @db.VarChar(255)
  stripe_payment_id     String?            @db.VarChar(255)
  amount                Int
  currency              String             @default("eur") @db.VarChar(3)
  status                PaymentStatus      @default(pending)
  description           String?
  metadata              Json?
  created_at            DateTime           @default(now())
  updated_at            DateTime           @updatedAt
  
  eventRegistration     EventRegistration? @relation(fields: [event_registration_id], references: [id])
  member                Member?            @relation(fields: [member_id], references: [id])
  order                 Order?             @relation(fields: [order_id], references: [id])

  @@index([payment_type])
  @@index([member_id])
  @@index([event_registration_id])
  @@index([order_id])
  @@index([stripe_session_id])
  @@index([status])
  @@index([created_at(sort: Desc)])
  @@map("payments")
}

// ========================================
// WAIVERS (Sin cambios)
// ========================================

model WaiverAcceptance {
  id                      String             @id @default(uuid()) @db.Uuid
  event_id                String             @db.Uuid
  waiver_version          String             @db.VarChar(50)
  participant_full_name   String             @db.VarChar(255)
  participant_document_id String             @db.VarChar(50)
  participant_birth_date  DateTime?          @db.Date
  waiver_text_hash        String             @db.VarChar(64)
  waiver_text             String?            @db.Text
  waiver_text_canonical   String?            @db.Text
  accepted_at             DateTime
  ip_address              String?            @db.VarChar(45)
  user_agent              String?
  created_at              DateTime           @default(now())
  updated_at              DateTime           @updatedAt
  event_registration_id   String?            @db.Uuid
  member_id               String?            @db.Uuid
  
  event                   Event              @relation(fields: [event_id], references: [id], onDelete: Cascade)
  eventRegistration       EventRegistration? @relation(fields: [event_registration_id], references: [id])
  member                  Member?            @relation(fields: [member_id], references: [id])

  @@unique([event_id, participant_document_id, waiver_version])
  @@index([event_id])
  @@index([participant_document_id])
  @@index([waiver_version])
  @@index([event_registration_id])
  @@index([member_id])
  @@index([accepted_at(sort: Desc)])
  @@map("waiver_acceptances")
}

// ========================================
// ENUMS
// ========================================

enum Sex {
  M
  F
  O
}

enum LicenseType {
  none
  a
  a_plus
  a_nac
  a_nac_plus
  b
  b_plus
  c
}

enum FedmeStatus {
  none
  pending
  processing
  active
  rejected
  expired
}

enum MembershipStatus {
  pending
  active
  expired
  failed
  cancelled
}

enum PaymentType {
  membership
  event
  order
  license_renewal
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
}

enum EventStatus {
  draft
  published
  sold_out
  cancelled
  completed
}

enum OrderStatus {
  pending
  paid
  processing
  shipped
  delivered
  cancelled
  refunded
}

enum RegistrationStatus {
  pending
  confirmed
  cancelled
  attended
  no_show
}

// ✅ NUEVO: Tipos de descuento
enum DiscountType {
  percentage
  fixed
}