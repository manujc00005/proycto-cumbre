// prisma/schema.prisma - DEFINITIVO

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS - DEBEN COINCIDIR CON constants.ts
// ============================================

enum Sex {
  M  // Masculino
  F  // Femenino
  O  // Otro
}

//  LICENCIAS FEDME 2025 - SOLO 6 TIPOS
enum LicenseType {
  none      // Sin licencia
  a         // A - Auton贸mica
  a_plus    // A+ - Auton贸mica Plus
  b         // B - Nacional
  b_plus    // B+ - Nacional Plus
  c         // C - Europea (siempre con extras)
}

enum FedmeStatus {
  none        // Usuario eligi贸 "Sin Licencia"
  pending     // Pendiente de tramitar
  processing  // En proceso con FEDME
  active      // Licencia activa
  rejected    // Rechazada por FEDME
  expired     // Expirada
}

enum MembershipStatus {
  pending    // Esperando pago
  active     // Pago completado, membres铆a activa
  expired    // Expir贸 despu茅s de 1 a帽o
  failed     // Pago rechazado
  cancelled  // Cancelada por admin
}

enum PaymentStatus {
  pending    // Pendiente
  completed  // Completado
  failed     // Fallido
  refunded   // Reembolsado
}

// ============================================
// TABLA: Headquarters (Sedes)
// ============================================

model Headquarters {
  id        String   @id @default(uuid())
  
  // Informaci贸n b谩sica
  name      String   @db.VarChar(255)
  code      String   @unique @db.VarChar(20)
  city      String   @db.VarChar(100)
  
  // Contacto
  phone     String?  @db.VarChar(20)
  email     String?  @db.VarChar(255)
  
  // Precios de membres铆a (JSONB)
  membership_prices Json
  
  // Estado
  status    String   @default("active") @db.VarChar(20)
  
  // Relaciones
  members   Member[]
  
  // Timestamps
  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt
  
  @@index([code])
  @@index([status])
  @@map("headquarters")
}

// ============================================
// TABLA: Members (Socios)
// ============================================

model Member {
  id                     String   @id @default(uuid())
  
  // Sede
  headquarters_id        String?
  headquarters           Headquarters? @relation(fields: [headquarters_id], references: [id])
  member_number          String?  @unique @db.VarChar(50)
  
  // Datos personales
  email                  String   @unique @db.VarChar(255)
  first_name             String   @db.VarChar(100)
  last_name              String   @db.VarChar(100)
  birth_date             DateTime @db.Date
  dni                    String   @unique @db.VarChar(20)
  sex                    Sex
  
  // Contacto
  phone                  String   @db.VarChar(20)
  emergency_phone        String?  @db.VarChar(20)
  emergency_contact_name String?  @db.VarChar(255)
  
  // Direcci贸n
  province               String   @db.VarChar(100)
  city                   String?  @db.VarChar(100)
  address                String   @db.Text
  postal_code            String?  @db.VarChar(10)
  
  // Tallas
  shirt_size             String?  @db.VarChar(10)
  hoodie_size            String?  @db.VarChar(10)
  pants_size             String?  @db.VarChar(10)
  
  // Licencia FEDME
  license_type           LicenseType
  fedme_license_number   String?  @unique @db.VarChar(50)
  fedme_status           FedmeStatus @default(pending)
  
  // Estado de membres铆a
  membership_status      MembershipStatus @default(pending)
  membership_start_date  DateTime?
  membership_end_date    DateTime?
  
  // Notas administrativas
  admin_notes            String?  @db.Text
  
  // Relaciones
  payments               Payment[]
  
  // Timestamps
  created_at             DateTime @default(now())
  updated_at             DateTime @default(now()) @updatedAt
  
  @@index([headquarters_id])
  @@index([email])
  @@index([dni])
  @@index([membership_status])
  @@index([member_number])
  @@index([created_at(sort: Desc)])
  @@map("members")
}

// ============================================
// TABLA: Payments (Pagos)
// ============================================

model Payment {
  id                String        @id @default(uuid())
  
  // Relaci贸n con socio
  member_id         String
  member            Member        @relation(fields: [member_id], references: [id], onDelete: Cascade)
  
  // Stripe
  stripe_session_id String        @unique @db.VarChar(255)
  stripe_payment_id String?       @db.VarChar(255)
  
  // Montos
  amount            Int
  currency          String        @default("eur") @db.VarChar(3)
  
  // Estado
  status            PaymentStatus @default(pending)
  
  // Metadata
  description       String?       @db.Text
  
  // Timestamps
  created_at        DateTime      @default(now())
  updated_at        DateTime      @default(now()) @updatedAt
  
  @@index([member_id])
  @@index([stripe_session_id])
  @@index([status])
  @@index([created_at(sort: Desc)])
  @@map("payments")
}